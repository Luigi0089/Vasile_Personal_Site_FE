<div class="week-toolbar">
  <button (click)="goPrevWeek()" class="btn-nav">‚Äπ</button>
  <div class="title">
    {{ weekStart | date:'dd/MM' }} ‚Äì {{ weekEnd | date:'dd/MM' }}
  </div>
  <button (click)="goNextWeek()" class="btn-nav">‚Ä∫</button>
</div>

<!-- Privacy Modal -->
<div class="privacy-modal-wrapper" *ngIf="privacyModalOpen">
  <div class="privacy-modal">
    <h2>Informativa sulla Privacy</h2>

    <div class="privacy-text">
      <p>
        Ai sensi del Regolamento (UE) 2016/679 (‚ÄúGDPR‚Äù) dichiaro di aver letto
        l‚Äôinformativa privacy e acconsento al trattamento dei miei dati personali
        inseriti nel modulo al solo scopo di gestire la richiesta di prenotazione
        della lezione e ricevere eventuali comunicazioni organizzative connesse.
      </p>
      <p>
        I dati saranno conservati per il tempo strettamente necessario alla gestione
        della richiesta e non saranno comunicati a terzi, salvo obblighi di legge.
        Potr√≤ in qualsiasi momento esercitare i diritti di accesso, rettifica,
        cancellazione, limitazione e opposizione scrivendo a
        <strong>prenotazionelezioneprivata&#64;gmail.com</strong>.
      </p>
      <p>
        Ho preso visione dell‚Äôinformativa completa disponibile al seguente link:
        <a routerLink="/privacy" target="_blank">Informativa Privacy completa</a>.
      </p>
    </div>

    <button class="btn-primary" (click)="acceptPrivacy()">
      Accetto e procedo
    </button>
  </div>
</div>



<div class="notice" *ngIf="errorMsg">{{ errorMsg }}</div>

<div class="grid" *ngIf="grid.length">
  <!-- header giorni -->
  <div class="col header"></div>
  <div class="col header" *ngFor="let d of daysISO; let i = index">
    {{ dayHeader(i) }}
  </div>

  <!-- righe slot (numero massimo di righe tra i giorni) -->
  <ng-container *ngFor="let rowIdx of grid[0]; let r = index">
    <div class="row">
      <div class="col rowtime">
        {{ grid[0][r].label }}
      </div>
      <div class="col cell"
           *ngFor="let dayCol of grid; let c = index"
           [class.empty]="!dayCol[r]"
           [class.busy]="dayCol[r].busy"
           [class.free]="dayCol[r] && !dayCol[r].busy && !isPastSlot(dayCol[r])"
           [class.past]="dayCol[r] && isPastSlot(dayCol[r])"
           (click)="dayCol[r] && !isPastSlot(dayCol[r]) && (dayCol[r].busy ? onClickBusy(dayCol[r]) : onClickFree(dayCol[r]))">
        <ng-container *ngIf="dayCol[r] as s">
          <div class="slot-label" *ngIf="!s.busy">Libero</div>
          <div class="slot-booked"
               *ngIf="s.busy"
               [title]="s.bookedBy?.materia || 'Prenotato'">
            {{ s.bookedBy?.materia  || 'Prenotato' }}
          </div>

        </ng-container>
      </div>
    </div>
  </ng-container>
</div>

<!-- MODALE -->
<div class="lezione-modal-wrapper" *ngIf="modalOpen">
  <div class="lezione-modal-backdrop" (click)="closeModal()"></div>

  <div class="lezione-modal" (click)="$event.stopPropagation()">
    <div class="modal-title">
      <h3>{{ isEdit ? 'Modifica lezione' : 'Prenota lezione' }}</h3>

    </div>

    <form [formGroup]="form" (ngSubmit)="submit()">
      <div class="form-grid">
        <div class="form-grid">

          <!-- Studente -->
          <div class="form-field">
            <label>Nome *</label>
            <input
              formControlName="nomeStudente"
              placeholder="Mario"
              [ngClass]="{ 'field-error': showError('nomeStudente') }"
            >

            <!-- obbligatorio -->
            <div class="error-msg" *ngIf="showError('nomeStudente') && form.get('nomeStudente')?.hasError('required')">
              Il nome dello studente √® obbligatorio.
            </div>

            <!-- parolacce -->
            <div class="error-msg" *ngIf="form.get('nomeStudente')?.hasError('profanity')">
              Il nome inserito contiene termini non appropriati.
            </div>
          </div>


          <!-- Email -->
          <div class="form-field" *ngIf="!isEdit">
            <label>Email *</label>
            <input
              type="email"
              formControlName="email"
              placeholder="es. mario.rossi@gmail.com"
              [ngClass]="{ 'field-error': showError('email') }"
            >
            <div class="error-msg" *ngIf="showError('email')">
              L'email √® obbligatoria e deve essere valida.
            </div>
          </div>

          <!-- Materia -->
          <div class="form-field">
            <label>Materia *</label>
            <input
              formControlName="materia"
              placeholder="Analisi 1"
              [ngClass]="{ 'field-error': showError('materia') }"
            >

            <!-- obbligatoria -->
            <div class="error-msg" *ngIf="showError('materia') && form.get('materia')?.hasError('required')">
              La materia √® obbligatoria.
            </div>

            <!-- parolacce -->
            <div class="error-msg" *ngIf="form.get('materia')?.hasError('profanity')">
              La materia contiene termini non appropriati.
            </div>
          </div>


          <!-- Livello -->
          <div class="form-field">
            <label>Livello</label>
            <select
              formControlName="livello"
              [ngClass]="{ 'field-error': showError('livello') }"
            >
              <option *ngFor="let l of livelli" [value]="l.value">{{ l.label }}</option>
            </select>
            <div class="error-msg" *ngIf="showError('livello')">
              Il livello √® obbligatorio.
            </div>
          </div>

          <!-- Data -->
          <div class="form-field">
            <label>Data *</label>
            <input
              formControlName="dataLezione"
              type="date"
              [ngClass]="{ 'field-error': showError('dataLezione') }"
            >
            <div class="error-msg" *ngIf="showError('dataLezione')">
              La data √® obbligatoria.
            </div>
          </div>

          <!-- Inizio -->
          <div class="form-field">
            <label>Inizio *</label>
            <select
              formControlName="orarioInizio"
              [ngClass]="{ 'field-error': showError('orarioInizio') }">
              <option value="" disabled>Seleziona orario</option>
              <option *ngFor="let t of timeOptions" [value]="t + ':00'">
                {{ t }}
              </option>
            </select>
            <div class="error-msg" *ngIf="showError('orarioInizio')">
              L'orario di inizio √® obbligatorio.
            </div>
          </div>


          <!-- Fine -->
          <div class="form-field">
            <label>Fine *</label>
            <select
              formControlName="orarioFine"
              [ngClass]="{ 'field-error': showError('orarioFine') }">
              <option value="" disabled>Seleziona orario</option>
              <option *ngFor="let t of timeOptions" [value]="t + ':00'">
                {{ t }}
              </option>
            </select>
            <div class="error-msg" *ngIf="showError('orarioFine')">
              L'orario di fine √® obbligatorio.
            </div>
          </div>


          <!-- Note (non obbligatorie) -->
          <div class="form-field full">
            <label>Note</label>
            <textarea
              formControlName="note"
              rows="2"
              placeholder="Preferisco esercizi sui limiti"
              [ngClass]="{ 'field-error': form.get('note')?.hasError('profanity') && form.get('note')?.touched }"
            ></textarea>

            <div class="error-msg" *ngIf="form.get('note')?.hasError('profanity') && form.get('note')?.touched">
              Le note contengono termini non appropriati.
            </div>
          </div>


          <!-- Codice modifica (solo in edit) -->
          <div class="form-field full" *ngIf="isEdit">
            <label>Codice modifica *</label>
            <input
              formControlName="codiceModifica"
              placeholder="Inserisci il codice di modifica"
              [ngClass]="{ 'field-error': showError('codiceModifica') }"
            >

            <!-- Obbligatorio -->
            <div class="error-msg"
                 *ngIf="form.get('codiceModifica')?.hasError('required') && showError('codiceModifica')">
              Il codice di modifica √® obbligatorio per modificare la lezione.
            </div>

            <!-- Errato lato backend -->
            <div class="error-msg"
                 *ngIf="form.get('codiceModifica')?.hasError('invalidCode')
              && !form.get('codiceModifica')?.hasError('required')">
              Il codice di modifica inserito non √® corretto.
            </div>
          </div>


        </div>

      </div>

      <!-- conflitto con suggerimenti -->
      <div class="conflict" *ngIf="conflict as c">
        <div class="conflict-title">Conflitto</div>
        <div class="conflict-msg">{{ c.message }}</div>
        <div class="conflict-slots" *ngIf="c.fasceDisponibili?.length">
          <div class="suggerimento" *ngFor="let f of c.fasceDisponibili">
            Suggerimento: {{ f.orarioInizio }} ‚Äì {{ f.orarioFine }}
          </div>
        </div>
      </div>

      <p class="required-hint">
        I campi contrassegnati con <span class="asterisk">*</span> sono obbligatori.
      </p>

      <div class="actions">
        <button
          type="submit"
          class="btn-primary"
          [disabled]="loading || form.invalid"
          [ngClass]="{ 'btn-disabled': loading || form.invalid }">
          {{ isEdit ? 'Salva modifiche' : 'Prenota' }}
        </button>

        <button
          type="button"
          class="btn-secondary"
          (click)="closeModal()">
          Annulla modifiche
        </button>

        <button
          type="button"
          class="btn-danger"
          *ngIf="isEdit && form.value.id"
          [disabled]="loading || form.invalid"
          [ngClass]="{ 'btn-disabled': loading || form.invalid }"
          (click)="annulla(form.value.id!)">
          Annulla lezione
        </button>

      </div>

    </form>
  </div>
</div>


<!-- MODALE SUCCESSO -->
<div class="lezione-success-wrapper" *ngIf="successModalOpen">
  <div class="lezione-success-backdrop" (click)="closeSuccessModal()"></div>

  <div class="lezione-success-modal" (click)="$event.stopPropagation()">
    <div class="lezione-success-header">
      <h3>Prenotazione confermata</h3>
      <button class="lezione-success-close" (click)="closeSuccessModal()">‚úï</button>
    </div>

    <div class="success-body" *ngIf="lastBooking as b">
      <p>La tua lezione √® stata prenotata correttamente üéâ</p>

      <!-- AVVISO EMAIL / SPAM -->
      <p class="mail-notice">
        Ti abbiamo inviato un'email di riepilogo con tutti i dettagli della prenotazione.
        Ti chiediamo gentilmente di controllare anche la cartella <strong>Spam</strong> o
        <strong>Posta indesiderata</strong> per assicurarti di ricevere gli aggiornamenti
        sullo stato della richiesta.
      </p>

      <ul class="riepilogo">
        <li><strong>Studente:</strong> {{ b.nomeStudente }}</li>
        <li><strong>Materia:</strong> {{ b.materia }}</li>
        <li><strong>Livello:</strong> {{ b.livello }}</li>
        <li><strong>Data:</strong> {{ b.dataLezione }}</li>
        <li><strong>Orario:</strong> {{ b.orarioInizio }} ‚Äì {{ b.orarioFine }}</li>

        <!-- STATO DELLA RICHIESTA -->
        <li>
          <strong>Stato della richiesta:</strong>
          {{ b.stato || 'In attesa di conferma da parte del docente' }}
        </li>
      </ul>

      <div class="codice-modifica-box" *ngIf="b.codiceModifica">
        <div class="label">
          Questo √® il tuo <strong>codice di modifica</strong>.<br>
          <span>Conservalo con cura: ti servir√† per modificare o annullare la lezione.</span>
        </div>
        <div class="codice">
          {{ b.codiceModifica }}
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn-primary" (click)="closeSuccessModal()">
          Ho salvato il codice
        </button>
      </div>
    </div>
  </div>
</div>


<!-- Overlay di caricamento -->
<div class="loading-overlay" *ngIf="loading">
  <div class="loading-spinner"></div>
</div>




